{% extends 'base.html' %}
{% block content %}
<div class="d-flex align-items-center mb-3">
  <button onclick="history.back()" class="btn btn-sm btn-outline-secondary me-2">← Back</button>
  <h1 class="mb-0">Series Books</h1>
</div>
{% if settings.developer_mode and user.role == 'admin' %}
<div class="alert alert-warning small">Developer mode is active — additional testing controls are visible below for each book.</div>
{% endif %}
<div class="card">
  <div class="card-body">
    <div id="seriesList"></div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const developerModeEnabled = {{ 'true' if settings.developer_mode else 'false' }};
const isAdminUser = {{ 'true' if user.role == 'admin' else 'false' }};
const showDeveloperControls = developerModeEnabled && isAdminUser;
async function loadSeries() {
  const params = new URLSearchParams(window.location.search);
  const requestedAsin = params.get('asin');
  const container = document.getElementById('seriesList');
  
  if (!requestedAsin) {
    container.innerHTML = '<div class="alert alert-info">No series specified. Please select a series from the Library or Series admin page.</div>';
    return;
  }
  
  // Fetch series data directly from database
  const r = await fetch(apiPath(`/api/series/info/${encodeURIComponent(requestedAsin)}`));
  if (!r.ok) {
    container.innerHTML = '<div class="alert alert-warning">Series not found or has no books yet.</div>';
    return;
  }
  
  const series = await r.json();
  
  container.innerHTML = '';
  if (!series.books || !Array.isArray(series.books) || series.books.length === 0) {
    container.innerHTML = '<div class="alert alert-info">This series has no books yet.</div>';
    return;
  }
  
  let runtimeMouseX = 0, runtimeMouseY = 0;
  let ratingMouseX = 0, ratingMouseY = 0;
  
  // Create chart for release dates
  const chartCard = document.createElement('div');
  chartCard.className = 'card mb-3';
  const chartHeader = document.createElement('div');
  chartHeader.className = 'card-header d-flex justify-content-between align-items-center';
  const headerTitle = document.createElement('h5');
  headerTitle.className = 'mb-0 d-flex align-items-center';
  headerTitle.style.cursor = 'pointer';
  headerTitle.setAttribute('data-bs-toggle', 'collapse');
  headerTitle.setAttribute('data-bs-target', '#statisticsCollapse');
  headerTitle.setAttribute('aria-expanded', 'false');
  headerTitle.setAttribute('aria-controls', 'statisticsCollapse');
  
  const chevronIcon = document.createElement('i');
  chevronIcon.className = 'bi bi-chevron-down me-2 collapse-icon';
  headerTitle.appendChild(chevronIcon);
  
  const titleText = document.createElement('span');
  titleText.textContent = 'Series Statistics';
  headerTitle.appendChild(titleText);
  
  headerTitle.onclick = () => {
    const isExpanded = headerTitle.getAttribute('aria-expanded') === 'true';
    headerTitle.setAttribute('aria-expanded', !isExpanded ? 'true' : 'false');
  };
  chartHeader.appendChild(headerTitle);
  chartCard.appendChild(chartHeader);
  const chartBody = document.createElement('div');
  chartBody.className = 'card-body collapse';
  chartBody.id = 'statisticsCollapse';
  
  // Create tabs
  const tabNav = document.createElement('ul');
  tabNav.className = 'nav nav-tabs';
  tabNav.setAttribute('role', 'tablist');
  
  const releaseTab = document.createElement('li');
  releaseTab.className = 'nav-item';
  releaseTab.setAttribute('role', 'presentation');
  const releaseTabLink = document.createElement('button');
  releaseTabLink.className = 'nav-link active';
  releaseTabLink.id = 'release-tab';
  releaseTabLink.setAttribute('data-bs-toggle', 'tab');
  releaseTabLink.setAttribute('data-bs-target', '#release-pane');
  releaseTabLink.setAttribute('type', 'button');
  releaseTabLink.setAttribute('role', 'tab');
  releaseTabLink.setAttribute('aria-controls', 'release-pane');
  releaseTabLink.setAttribute('aria-selected', 'true');
  releaseTabLink.textContent = 'Release Dates';
  releaseTab.appendChild(releaseTabLink);
  tabNav.appendChild(releaseTab);
  
  const runtimeTab = document.createElement('li');
  runtimeTab.className = 'nav-item';
  runtimeTab.setAttribute('role', 'presentation');
  const runtimeTabLink = document.createElement('button');
  runtimeTabLink.className = 'nav-link';
  runtimeTabLink.id = 'runtime-tab';
  runtimeTabLink.setAttribute('data-bs-toggle', 'tab');
  runtimeTabLink.setAttribute('data-bs-target', '#runtime-pane');
  runtimeTabLink.setAttribute('type', 'button');
  runtimeTabLink.setAttribute('role', 'tab');
  runtimeTabLink.setAttribute('aria-controls', 'runtime-pane');
  runtimeTabLink.setAttribute('aria-selected', 'false');
  runtimeTabLink.textContent = 'Runtime';
  runtimeTab.appendChild(runtimeTabLink);
  tabNav.appendChild(runtimeTab);
  
  const ratingTab = document.createElement('li');
  ratingTab.className = 'nav-item';
  ratingTab.setAttribute('role', 'presentation');
  const ratingTabLink = document.createElement('button');
  ratingTabLink.className = 'nav-link';
  ratingTabLink.id = 'rating-tab';
  ratingTabLink.setAttribute('data-bs-toggle', 'tab');
  ratingTabLink.setAttribute('data-bs-target', '#rating-pane');
  ratingTabLink.setAttribute('type', 'button');
  ratingTabLink.setAttribute('role', 'tab');
  ratingTabLink.setAttribute('aria-controls', 'rating-pane');
  ratingTabLink.setAttribute('aria-selected', 'false');
  ratingTabLink.textContent = 'Ratings';
  ratingTab.appendChild(ratingTabLink);
  tabNav.appendChild(ratingTab);
  
  chartBody.appendChild(tabNav);
  
  const tabContent = document.createElement('div');
  tabContent.className = 'tab-content mt-3';
  
  // Release dates tab pane
  const releasePane = document.createElement('div');
  releasePane.className = 'tab-pane fade show active';
  releasePane.id = 'release-pane';
  releasePane.setAttribute('role', 'tabpanel');
  releasePane.setAttribute('aria-labelledby', 'release-tab');
  const releaseCanvas = document.createElement('canvas');
  releaseCanvas.style.maxHeight = '300px';
  releasePane.appendChild(releaseCanvas);
  tabContent.appendChild(releasePane);
  
  // Runtime tab pane
  const runtimePane = document.createElement('div');
  runtimePane.className = 'tab-pane fade';
  runtimePane.id = 'runtime-pane';
  runtimePane.setAttribute('role', 'tabpanel');
  runtimePane.setAttribute('aria-labelledby', 'runtime-tab');
  const runtimeCanvas = document.createElement('canvas');
  runtimeCanvas.style.maxHeight = '300px';
  runtimePane.appendChild(runtimeCanvas);
  tabContent.appendChild(runtimePane);
  
  // Rating tab pane
  const ratingPane = document.createElement('div');
  ratingPane.className = 'tab-pane fade';
  ratingPane.id = 'rating-pane';
  ratingPane.setAttribute('role', 'tabpanel');
  ratingPane.setAttribute('aria-labelledby', 'rating-tab');
  const ratingCanvas = document.createElement('canvas');
  ratingCanvas.style.maxHeight = '300px';
  ratingPane.appendChild(ratingCanvas);
  tabContent.appendChild(ratingPane);
  
  chartBody.appendChild(tabContent);
  chartCard.appendChild(chartBody);
  container.appendChild(chartCard);
  
  // Add chevron rotation for statistics collapse
  const statisticsCollapse = chartBody;
  statisticsCollapse.addEventListener('shown.bs.collapse', function () {
    const header = statisticsCollapse.previousElementSibling.querySelector('h5');
    if (header) header.classList.remove('collapsed');
  });
  statisticsCollapse.addEventListener('hidden.bs.collapse', function () {
    const header = statisticsCollapse.previousElementSibling.querySelector('h5');
    if (header) header.classList.add('collapsed');
  });
  
  // Collect release years and runtime data
  const yearCounts = {};
  const runtimeData = [];
  const ratingData = [];
  series.books.forEach(book => {
    if (book.release_date && new Date(book.release_date) <= new Date()) {
      const year = book.release_date.split('-')[0];
      if (year && /^\d{4}$/.test(year)) {
        yearCounts[year] = (yearCounts[year] || 0) + 1;
      }
    }
    if (book.release_date && new Date(book.release_date) <= new Date() && book.runtime && typeof book.runtime === 'number') {
      runtimeData.push({
        date: book.release_date,
        runtime: book.runtime / 60,  // Convert to hours
        title: book.title || 'Unknown',
        image: book.image
      });
    }
    if (book.release_date && new Date(book.release_date) <= new Date() && book.raw && book.raw.rating && book.raw.rating.overall_distribution && book.raw.rating.overall_distribution.display_average_rating) {
      const rating = parseFloat(book.raw.rating.overall_distribution.display_average_rating);
      if (!isNaN(rating)) {
        ratingData.push({
          date: book.release_date,
          rating: rating,
          title: book.title || 'Unknown',
          image: book.image
        });
      }
    }
  });
  const years = Object.keys(yearCounts).sort();
  const counts = years.map(year => yearCounts[year]);
  
  // Sort runtime data by date
  runtimeData.sort((a, b) => a.date.localeCompare(b.date));
  const runtimeLabels = runtimeData.map(d => d.title);
  const runtimeValues = runtimeData.map(d => d.runtime);
  
  // Sort rating data by date
  ratingData.sort((a, b) => a.date.localeCompare(b.date));
  const ratingLabels = ratingData.map(d => d.title);
  const ratingValues = ratingData.map(d => d.rating);
  
  // Create release chart
  new Chart(releaseCanvas, {
    type: 'line',
    data: {
      labels: years,
      datasets: [{
        label: 'Books Released',
        data: counts,
        backgroundColor: 'rgba(54, 162, 235, 0.5)',
        borderColor: 'rgba(54, 162, 235, 1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            stepSize: 1
          }
        }
      }
    }
  });
  
  // Create runtime chart if data exists
  if (runtimeData.length > 0) {
    new Chart(runtimeCanvas, {
      type: 'line',
      data: {
        labels: runtimeLabels,
        datasets: [{
          label: 'Runtime (hours)',
          data: runtimeValues,
          backgroundColor: 'rgba(255, 99, 132, 0.5)',
          borderColor: 'rgba(255, 99, 132, 1)',
          borderWidth: 1,
          pointRadius: 3,
          pointHoverRadius: 5
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            title: {
              display: true,
              text: 'Book Title'
            }
          },
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Runtime (hours)'
            }
          }
        },
        plugins: {
          tooltip: {
            enabled: false,
            external: function(context) {
              let tooltipEl = document.getElementById('runtime-tooltip');
              if (!tooltipEl) {
                tooltipEl = document.createElement('div');
                tooltipEl.id = 'runtime-tooltip';
                tooltipEl.style.position = 'absolute';
                tooltipEl.style.pointerEvents = 'none';
                tooltipEl.style.background = 'rgba(0,0,0,0.8)';
                tooltipEl.style.color = 'white';
                tooltipEl.style.padding = '5px 10px';
                tooltipEl.style.borderRadius = '4px';
                tooltipEl.style.fontSize = '12px';
                tooltipEl.style.zIndex = '1000';
                document.body.appendChild(tooltipEl);
              }
              const tooltip = context.tooltip;
              if (tooltip.opacity === 0) {
                tooltipEl.style.opacity = 0;
                return;
              }
              const index = tooltip.dataPoints[0].dataIndex;
              const data = runtimeData[index];
              tooltipEl.innerHTML = data.image ? `<img src="${data.image}" style="width: 120px; height: auto; margin-right: 8px; vertical-align: middle;"> ${data.title}` : data.title;
              tooltipEl.style.left = runtimeMouseX + 10 + 'px';
              tooltipEl.style.top = runtimeMouseY - 10 + 'px';
              tooltipEl.style.opacity = 1;
            }
          }
        }
      }
    });
    runtimeCanvas.addEventListener('mousemove', (e) => {
      runtimeMouseX = e.clientX;
      runtimeMouseY = e.clientY;
    });
  } else {
    // If no runtime data, hide the runtime tab
    runtimeTab.style.display = 'none';
  }
  
  // Create rating chart if data exists
  if (ratingData.length > 0) {
    new Chart(ratingCanvas, {
      type: 'line',
      data: {
        labels: ratingLabels,
        datasets: [{
          label: 'Average Rating',
          data: ratingValues,
          backgroundColor: 'rgba(75, 192, 192, 0.5)',
          borderColor: 'rgba(75, 192, 192, 1)',
          borderWidth: 1,
          pointRadius: 3,
          pointHoverRadius: 5
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            title: {
              display: true,
              text: 'Book Title'
            }
          },
          y: {
            beginAtZero: false,
            min: 0,
            max: 5,
            title: {
              display: true,
              text: 'Rating'
            }
          }
        },
        plugins: {
          tooltip: {
            enabled: false,
            external: function(context) {
              let tooltipEl = document.getElementById('rating-tooltip');
              if (!tooltipEl) {
                tooltipEl = document.createElement('div');
                tooltipEl.id = 'rating-tooltip';
                tooltipEl.style.position = 'absolute';
                tooltipEl.style.pointerEvents = 'none';
                tooltipEl.style.background = 'rgba(0,0,0,0.8)';
                tooltipEl.style.color = 'white';
                tooltipEl.style.padding = '5px 10px';
                tooltipEl.style.borderRadius = '4px';
                tooltipEl.style.fontSize = '12px';
                tooltipEl.style.zIndex = '1000';
                document.body.appendChild(tooltipEl);
              }
              const tooltip = context.tooltip;
              if (tooltip.opacity === 0) {
                tooltipEl.style.opacity = 0;
                return;
              }
              const index = tooltip.dataPoints[0].dataIndex;
              const data = ratingData[index];
              tooltipEl.innerHTML = data.image ? `<img src="${data.image}" style="width: 120px; height: auto; margin-right: 8px; vertical-align: middle;"> ${data.title}` : data.title;
              tooltipEl.style.left = ratingMouseX + 10 + 'px';
              tooltipEl.style.top = ratingMouseY - 10 + 'px';
              tooltipEl.style.opacity = 1;
            }
          }
        }
      }
    });
    ratingCanvas.addEventListener('mousemove', (e) => {
      ratingMouseX = e.clientX;
      ratingMouseY = e.clientY;
    });
  } else {
    // If no rating data, hide the rating tab
    ratingTab.style.display = 'none';
  }
  
  const list = document.createElement('div');
  const card = document.createElement('div');
  card.className = 'card mb-3';
  
  const header = document.createElement('div');
  header.className = 'card-header';
  const title = document.createElement('h5');
  title.className = 'mb-0';
  title.textContent = series.title || 'Unknown Series';
  if (series.original_title && series.original_title !== series.title) {
    const original = document.createElement('small');
    original.className = 'text-muted ms-2';
    original.textContent = `(${series.original_title})`;
    title.appendChild(original);
  }
  header.appendChild(title);
  
  const body = document.createElement('div');
  body.className = 'card-body';
  const ul = document.createElement('ul');
  ul.className = 'list-group list-group-flush';
  series.books.forEach(b => {
      const li = document.createElement('li');
      li.className = 'list-group-item';
      let hidden = Boolean(b.hidden);
      if (hidden) {
        li.classList.add('series-book-hidden');
      }
      
      // Title
      const titleDiv = document.createElement('div');
      titleDiv.className = 'mb-2';
      const titleEl = document.createElement(b.url && (b.url.startsWith('http://') || b.url.startsWith('https://')) ? 'a' : 'strong');
      if (titleEl.tagName === 'A') {
        titleEl.href = b.url;
        titleEl.target = '_blank';
        titleEl.rel = 'noreferrer noopener';
        titleEl.className = 'text-decoration-none';
      }
      titleEl.textContent = b.title || 'Unknown';
      const strong = document.createElement('strong');
      strong.appendChild(titleEl);
      titleDiv.appendChild(strong);
      li.appendChild(titleDiv);
      
      // Book details
      const detailsDiv = document.createElement('div');
      detailsDiv.className = 'small text-muted';
      const details = [];
      if (b.asin) details.push(`ASIN: ${b.asin}`);
      if (b.narrators) details.push(`Narrator: ${b.narrators}`);
      if (b.release_date) details.push(`Released: ${b.release_date}`);
      if (b.runtime) {
        const runtime = typeof b.runtime === 'number' ? b.runtime : parseInt(b.runtime);
        if (!isNaN(runtime)) {
          const hours = Math.floor(runtime / 60);
          const mins = runtime % 60;
          details.push(`Runtime: ${hours}h ${mins}m`);
        }
      }
      detailsDiv.innerHTML = details.join(' • ');
      li.appendChild(detailsDiv);
      
      // Image
      if (b.image) {
        const imgDiv = document.createElement('div');
        imgDiv.className = 'mt-2';
        const img = document.createElement('img');
        img.src = b.image;
        img.alt = b.title || 'Book cover';
        img.className = 'img-thumbnail';
        img.style.maxWidth = '150px';
        imgDiv.appendChild(img);
        li.appendChild(imgDiv);
      }

      const controls = document.createElement('div');
      controls.className = 'd-flex flex-wrap align-items-center gap-2 mt-2';
      const hiddenBadge = document.createElement('span');
      hiddenBadge.className = 'badge bg-warning text-dark';
      hiddenBadge.textContent = 'Hidden';
      hiddenBadge.style.display = hidden ? '' : 'none';
      controls.appendChild(hiddenBadge);
      
      // Only show visibility toggle button for admin users
      if (isAdminUser) {
        const toggleBtn = document.createElement('button');
        toggleBtn.className = 'btn btn-sm btn-outline-secondary';
        toggleBtn.textContent = hidden ? 'Show in public lists' : 'Hide from public lists';
        toggleBtn.onclick = async () => {
          toggleBtn.disabled = true;
          try {
            await updateSeriesBookVisibility(series.asin, b, !hidden);
            hidden = !hidden;
            b.hidden = hidden;
            hiddenBadge.style.display = hidden ? '' : 'none';
            toggleBtn.textContent = hidden ? 'Show in public lists' : 'Hide from public lists';
          } catch (err) {
            console.error(err);
          } finally {
            toggleBtn.disabled = false;
          }
        };
        controls.appendChild(toggleBtn);
      }
      
      li.appendChild(controls);

      if (showDeveloperControls && series.asin) {
        const devSection = document.createElement('div');
        devSection.className = 'developer-controls border-top pt-3 mt-3';
        const devRow = document.createElement('div');
        devRow.className = 'd-flex flex-wrap align-items-center gap-2';

        // Developer helper: set publication datetime to now (UTC) and clear release notification flag
        const pubSetBtn = document.createElement('button');
        pubSetBtn.className = 'btn btn-sm btn-outline-primary';
        pubSetBtn.textContent = 'Set publication to now';
        pubSetBtn.setAttribute('aria-label', 'Set publication datetime to current UTC time and clear release notification flag');
        pubSetBtn.setAttribute('title', 'Also clears the release notification marker for this book');
        pubSetBtn.onclick = async () => {
          pubSetBtn.disabled = true;
          pubSetBtn.textContent = 'Setting...';
          setDevFeedback(devStatus, '', false);
          try {
            // Request server to set publication_datetime to server UTC now
            await updatePublicationDatetime(series.asin, b, null);
            setDevFeedback(devStatus, 'Requested server to set publication datetime to now (UTC) and cleared release notification state', false);
            await loadSeries();
          } catch (err) {
            console.error(err);
            setDevFeedback(devStatus, err?.message || 'Failed to set datetime', true);
          } finally {
            pubSetBtn.disabled = false;
            pubSetBtn.textContent = 'Set publication to now';
          }
        };
        devRow.appendChild(pubSetBtn);

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn btn-sm btn-outline-danger';
        deleteBtn.textContent = 'Delete book';
        deleteBtn.onclick = async () => {
          if (!confirm('Delete this book from the cached list? Refreshing will re-fetch it from the source.')) {
            return;
          }
          deleteBtn.disabled = true;
          deleteBtn.textContent = 'Deleting...';
          setDevFeedback(devStatus, '', false);
          try {
            await deleteSeriesBook(series.asin, b);
            setDevFeedback(devStatus, 'Book deleted (refreshing)...', false);
            await loadSeries();
          } catch (err) {
            console.error(err);
            setDevFeedback(devStatus, err?.message || 'Failed to delete book', true);
          } finally {
            deleteBtn.disabled = false;
            deleteBtn.textContent = 'Delete book';
          }
        };
        devRow.appendChild(deleteBtn);

        const devStatus = document.createElement('small');
        devStatus.className = 'text-muted d-block mt-2';
        devStatus.style.minHeight = '1.2em';
        devStatus.style.display = 'none';
        devSection.appendChild(devRow);
        const pubHelper = document.createElement('small');
        pubHelper.className = 'form-text text-muted mt-2';
        pubHelper.textContent = 'Developer: click the button to set the publication datetime to the current UTC time plus one minute.';
        devSection.appendChild(pubHelper);
        devSection.appendChild(devStatus);
        li.appendChild(devSection);
      }
      
      // Raw data (collapsed by default)
      if (b.raw) {
        const rawToggle = document.createElement('button');
        rawToggle.className = 'btn btn-sm btn-link text-muted mt-2 p-0';
        rawToggle.textContent = 'Show raw data';
        const searchWrap = document.createElement('div');
        searchWrap.className = 'mt-2';
        searchWrap.style.display = 'none';
        const inputGroup = document.createElement('div');
        inputGroup.className = 'input-group input-group-sm mb-2';
        inputGroup.style.maxWidth = '320px';
        const input = document.createElement('input');
        input.className = 'form-control';
        input.placeholder = 'Search JSON';
        const clearBtn = document.createElement('button');
        clearBtn.className = 'btn btn-outline-secondary';
        clearBtn.textContent = 'Clear';
        inputGroup.appendChild(input);
        inputGroup.appendChild(clearBtn);
        searchWrap.appendChild(inputGroup);
        const rawPre = document.createElement('pre');
        rawPre.className = 'small json-pre p-2 mt-2 rounded';
        rawPre.style.whiteSpace = 'pre-wrap';
        rawPre.style.display = 'none';
        const rawStr = JSON.stringify(b.raw, null, 2);
        rawPre.dataset.json = rawStr;
        rawPre.innerHTML = syntaxHighlight(rawStr);
        rawToggle.onclick = () => {
          if (rawPre.style.display === 'none') {
            searchWrap.style.display = '';
            rawPre.style.display = 'block';
            rawToggle.textContent = 'Hide raw data';
          } else {
            searchWrap.style.display = 'none';
            rawPre.style.display = 'none';
            rawToggle.textContent = 'Show raw data';
          }
        };
        input.oninput = () => highlightJson(rawPre, input.value);
        clearBtn.onclick = () => { input.value=''; highlightJson(rawPre, ''); };
        li.appendChild(rawToggle);
        li.appendChild(searchWrap);
        li.appendChild(rawPre);
      }
      
      ul.appendChild(li);
  });
  body.appendChild(ul);
  card.appendChild(header);
  card.appendChild(body);
  list.appendChild(card);
  container.appendChild(list);
  try {
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.forEach(function (tooltipTriggerEl) { new bootstrap.Tooltip(tooltipTriggerEl); });
  } catch (e) { /* non-fatal */ }
}

loadSeries();

function syntaxHighlight(json) {
  json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
    let cls = 'json-number';
    if (/^"/.test(match)) {
      if (/:$/.test(match)) {
        cls = 'json-key';
      } else {
        cls = 'json-string';
      }
    } else if (/true|false/.test(match)) {
      cls = 'json-boolean';
    } else if (/null/.test(match)) {
      cls = 'json-null';
    }
    return '<span class="' + cls + '">' + match + '</span>';
  });
}

async function updateSeriesBookVisibility(seriesAsin, book, hidden) {
  if (!seriesAsin) {
    throw new Error('Series ASIN missing');
  }
  const payload = { hidden: Boolean(hidden) };
  if (book.asin) {
    payload.book_asin = book.asin;
  } else if (book.title) {
    payload.title = book.title;
  } else {
    throw new Error('Book identifier missing');
  }
  const resp = await fetch(apiPath(`/api/series/${encodeURIComponent(seriesAsin)}/books/visibility`), {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload),
  });
  if (!resp.ok) {
    const text = await resp.text();
    throw new Error(text || 'Failed to update book visibility');
  }
  return resp.json();
}

async function markBookAsNew(seriesAsin, book) {
  return developerRequest('POST', `/api/developer/series/${encodeURIComponent(seriesAsin)}/books/mark-new`, bookPayload(book));
}

async function updatePublicationDatetime(seriesAsin, book, datetime) {
  // Update the book's raw publication_datetime only (developer-only helper)
  return developerRequest('POST', `/api/developer/series/${encodeURIComponent(seriesAsin)}/books/update-publication-raw`, {
    ...bookPayload(book),
    publication_datetime: datetime,
  });
}

async function deleteSeriesBook(seriesAsin, book) {
  return developerRequest('DELETE', `/api/developer/series/${encodeURIComponent(seriesAsin)}/books`, bookPayload(book));
}

function bookPayload(book) {
  return {
    book_asin: book.asin || null,
    title: book.title || null,
  };
}

function getBookPublicationDatetime(book) {
  if (!book) {
    return '';
  }
  const value = book.publication_datetime;
  if (typeof value === 'string' && value.trim()) {
    return value.trim();
  }
  const releaseDate = book.release_date;
  if (typeof releaseDate === 'string' && releaseDate.trim()) {
    const trimmed = releaseDate.trim();
    if (/^\d{4}-\d{2}-\d{2}$/.test(trimmed)) {
      return `${trimmed}T00:00:00Z`;
    }
    return trimmed;
  }
  return '';
}

async function developerRequest(method, path, payload) {
  const options = { method, headers: { 'Content-Type': 'application/json' } };
  if (payload !== undefined) {
    options.body = JSON.stringify(payload);
  }
  const resp = await fetch(apiPath(path), options);
  if (!resp.ok) {
    const text = await resp.text();
    throw new Error(text || 'Developer request failed');
  }
  return resp.json();
}

function setDevFeedback(el, message, isError = false) {
  if (!el) {
    return;
  }
  if (!message) {
    el.style.display = 'none';
    el.textContent = '';
    el.classList.remove('text-success', 'text-danger');
    el.classList.add('text-muted');
    return;
  }
  el.style.display = '';
  el.textContent = message;
  el.classList.toggle('text-danger', !!isError);
  el.classList.toggle('text-success', !!message && !isError);
  if (!isError) {
    el.classList.remove('text-danger');
  }
}

function highlightJson(preEl, term) {
  const src = preEl.dataset.json || '';
  if (!term) {
    preEl.innerHTML = syntaxHighlight(src);
    return;
  }
  const html = syntaxHighlight(src);
  // Rebuild with highlights without breaking tags
  preEl.innerHTML = html;
  const walker = document.createTreeWalker(preEl, NodeFilter.SHOW_TEXT, null);
  const toProcess = [];
  while (walker.nextNode()) {
    const node = walker.currentNode;
    if (node.nodeValue && node.nodeValue.toLowerCase().includes(term.toLowerCase())) {
      toProcess.push(node);
    }
  }
  const re = new RegExp(`(${escapeRegex(term)})`, 'gi');
  toProcess.forEach(node => {
    const parent = node.parentNode;
    const parts = node.nodeValue.split(re);
    const frag = document.createDocumentFragment();
    parts.forEach(part => {
      if (re.test(part)) {
        const mark = document.createElement('mark');
        mark.textContent = part;
        frag.appendChild(mark);
      } else {
        frag.appendChild(document.createTextNode(part));
      }
    });
    parent.replaceChild(frag, node);
  });
}

function escapeRegex(s) {
  return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}
</script>
{% endblock %}

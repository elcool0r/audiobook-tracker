{% extends 'base.html' %}
{% block content %}
<h1>Settings</h1>
{% if user.role != 'admin' %}
<div class="alert alert-warning">Only admin can update settings.</div>
{% endif %}
<form id="settingsForm" {% if user.role != 'admin' %}disabled{% endif %}>
  <div class="mb-3">
    <label class="form-label">Public landing Page</label>
    <select class="form-select" name="default_frontpage_slug" id="defaultFrontpageSlugSelect">
      <option value="">(none — show login)</option>
    </select>
    <div class="form-text">Visitors that are not signed in will be redirected to /home/&lt;slug&gt; when / is opened. Choose an existing user slug or leave empty to show the login screen.</div>
    {% if settings.developer_mode %}
    <div class="form-check form-switch mt-2">
      <input class="form-check-input" type="checkbox" name="users_can_edit_frontpage_slug" id="usersCanEditFrontpageSlug" {% if settings.users_can_edit_frontpage_slug %}checked{% endif %} />
      <label class="form-check-label" for="usersCanEditFrontpageSlug">Users can edit Frontpage slug</label>
      <div class="form-text">When enabled, users can change their public page slug from their profile.</div>
    </div>
    {% endif %}
  </div>
{% if settings.developer_mode %}
  <div class="mb-3">
    <label class="form-label">API Request Rate limit(requests per second)</label>
    <input class="form-control" name="rate_rps" value="{{ settings.rate_rps }}" />
  </div>
  <div class="mb-3">
    <label class="form-label">Max job history</label>
    <input class="form-control" name="max_job_history" type="number" value="{{ settings.max_job_history }}" />
    <div class="form-text">Maximum number of jobs to keep in history. Older jobs will be automatically pruned.</div>
  </div>
{% endif %}
  
  <div class="card mb-3">
    <div class="card-header">API Settings</div>
    <div class="card-body">
      <div class="mb-3">
        <label class="form-label">User Agent (optional)</label>
        <input class="form-control" name="user_agent" placeholder="e.g., Mozilla/5.0 (Windows NT 10.0; Win64; x64)" value="{{ settings.user_agent or '' }}" />
        <div class="form-text">Custom User-Agent header for API requests. Leave empty to use default: Audible/671 CFNetwork/1240.0.4 Darwin/20.6.0</div>
      </div>
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" name="allow_non_admin_series_search" id="allowNonAdminSeriesSearch" {% if settings.allow_non_admin_series_search %}checked{% endif %} />
        <label class="form-check-label" for="allowNonAdminSeriesSearch">Allow non-admin users to search series online</label>
      </div>
      <div class="form-check form-switch mt-2">
        <input class="form-check-input" type="checkbox" name="skip_known_series_search" id="skipKnownSeriesSearchToggle" {% if settings.skip_known_series_search %}checked{% endif %} />
        <label class="form-check-label" for="skipKnownSeriesSearchToggle">Skip series search when the title is already known</label>
        <div class="form-text">When enabled, searching for an exact known title returns a shortcut response instead of querying Audible.</div>
      </div>
{% if settings.developer_mode %}
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" name="debug_logging" id="debugLoggingToggle" {% if settings.debug_logging %}checked{% endif %} />
        <label class="form-check-label" for="debugLoggingToggle">Enable debug logging</label>
        <div class="form-text">Enable detailed logging for troubleshooting. Requires app restart to take effect.</div>
      </div>
{% endif %}
    </div>
  </div>



  <div class="card mb-3">
    <div class="card-header">Proxy Settings</div>
    <div class="card-body">
      <div class="form-check form-switch mb-3">
        <input class="form-check-input" type="checkbox" name="proxy_enabled" id="proxyEnabledToggle" {% if settings.proxy_enabled %}checked{% endif %} />
        <label class="form-check-label" for="proxyEnabledToggle">Enable proxy</label>
      </div>
      <div class="mb-3">
        <label class="form-label">Proxy URL</label>
        <input class="form-control" name="proxy_url" placeholder="http://proxy.example.com:8080" value="{{ settings.proxy_url or '' }}" />
        <div class="form-text">Format: http://host:port, https://host:port, or socks5://host:port</div>
      </div>
      <div class="row">
        <div class="col-md-6 mb-3">
          <label class="form-label">Proxy username (optional)</label>
          <input class="form-control" name="proxy_username" value="{{ settings.proxy_username or '' }}" />
        </div>
        <div class="col-md-6 mb-3">
          <label class="form-label">Proxy password (optional)</label>
          <input class="form-control" name="proxy_password" type="password" value="{{ settings.proxy_password or '' }}" data-bwignore="true" />
        </div>
      </div>
      <button type="button" class="btn btn-sm btn-outline-secondary" id="testProxyBtn">Test Proxy Connection</button>
      <div id="proxyTestResult" class="mt-2" style="display:none"></div>
    </div>
  </div>

  <div class="card mb-3">
    <div class="card-header">Auto-Refresh Settings</div>
    <div class="card-body">
      <div class="mb-3">
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" name="auto_refresh_enabled" id="autoRefreshToggle" {% if settings.auto_refresh_enabled %}checked{% endif %} />
          <label class="form-check-label" for="autoRefreshToggle">Enable automatic series refresh</label>
        </div>
        <div class="form-text">When enabled, series will be automatically refreshed on a periodic schedule.</div>
      </div>
      <div class="mb-3">
        <button type="button" class="btn btn-sm btn-outline-primary two-step-confirm" id="assignScheduleBtn">Assign new schedule to all series</button>
        <button type="button" class="btn btn-sm btn-outline-secondary ms-2 two-step-confirm" id="refreshAllBtn">Refresh All Series now</button>
        <div id="rescheduleResult" class="mt-2" style="display:none"></div>
      </div>
    </div>
  </div>

{% if settings.developer_mode %}
  <div class="card mb-3">
    <div class="card-header">Analytics</div>
    <div class="card-body">
      <div class="mb-3">
        <label class="form-label">Google Analytics ID (optional)</label>
        <input class="form-control"
               name="google_analytics_id"
               placeholder="G-XXXXXXXXXX or UA-XXXXXXXXX-X"
               value="{{ settings.google_analytics_id or '' }}"
               pattern="^(G-[A-Z0-9]{10}|UA-\d{4,10}-\d{1,4})$"
               title="Enter a valid Google Analytics ID (e.g., G-XXXXXXXXXX or UA-XXXXXXXXX-X)" />
        <div class="form-text">Google Analytics Measurement ID for tracking frontpage visits. Leave empty to disable analytics.</div>
      </div>
    </div>
  </div>
{% endif %}

{% if settings.developer_mode %}
  <div class="card mb-3">
    <div class="card-header">Database Maintenance</div>
    <div class="card-body">
      <p class="text-muted small">Remove cached series data and compact database to reclaim disk space. Series titles will be preserved and data will be re-fetched on next refresh.</p>
      <p class="text-warning small"><strong>Note:</strong> These operations may take several minutes and will lock the database. The application may be unresponsive during this time.</p>
      <button type="button" class="btn btn-sm btn-outline-info me-2" id="showDbStatsBtn">Show Database Stats</button>
      <button type="button" class="btn btn-sm btn-outline-danger me-2 two-step-confirm" id="purgeAndCompactBtn">Purge & Compact Database</button>
      <button type="button" class="btn btn-sm btn-outline-warning two-step-confirm" id="dumpRestoreBtn">Dump & Restore (Reclaim Space)</button>
      <div id="dbStatsResult" class="mt-3" style="display:none"></div>
      <div id="purgeResult" class="mt-2" style="display:none"></div>
      <div id="dumpRestoreResult" class="mt-2" style="display:none"></div>
    </div>
  </div>
{% endif %}
  
  <!-- Developer Mode moved to bottom -->
  <div class="card mb-3">
    <div class="card-header">Developer Mode</div>
    <div class="card-body">
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" name="developer_mode" id="developerModeToggle" {% if settings.developer_mode %}checked{% endif %} />
        <label class="form-check-label" for="developerModeToggle">Enable developer mode</label>
      </div>
      <div class="form-text">Enabling this reveals developer-only testing controls (notifications, book edits, duplication) across the admin interface.</div>
    </div>
  </div>

  <button class="btn btn-primary">Save</button>
</form>
<div id="saved" style="display:none" class="alert alert-success mt-3">Saved</div>
<script>
let currentSettings = null;
function syncProxyFields() {
  const enabled = document.querySelector('[name=proxy_enabled]').checked;
  ['proxy_url','proxy_username','proxy_password'].forEach(name => {
    const el = document.querySelector(`[name=${name}]`);
    if (el) el.disabled = !enabled;
  });
  const testBtn = document.getElementById('testProxyBtn');
  if (testBtn) testBtn.disabled = !enabled;
}
async function loadFrontpageSlugOptions() {
  try {
    const r = await fetch(apiPath('/api/users'));
    if (!r.ok) return;
    const users = await r.json();
    const select = document.getElementById('defaultFrontpageSlugSelect');
    if (!select) return;
    // Clear existing (but keep the first "none" option)
    select.querySelectorAll('option:not([value=""])').forEach(e => e.remove());
    const seen = new Set();
    users.forEach(u => {
      const slug = (u.frontpage_slug || u.username || '').trim();
      if (!slug || seen.has(slug)) return;
      seen.add(slug);
      const option = document.createElement('option');
      option.value = slug;
      option.textContent = u.username || slug;
      select.appendChild(option);
    });
  } catch (err) {
    console.error('Failed to load landing slug options', err);
  }
}
async function loadSettings() {
  const r = await fetch(apiPath('/api/settings'));
  if (r.ok) {
    currentSettings = await r.json();
    const defaultFp = document.querySelector('[name=default_frontpage_slug]');
    const selectFp = document.getElementById('defaultFrontpageSlugSelect');
    if (selectFp) selectFp.value = currentSettings.default_frontpage_slug || '';

    const rateEl = document.querySelector('[name=rate_rps]');
    if (rateEl) rateEl.value = currentSettings.rate_rps;

    const maxJobEl = document.querySelector('[name=max_job_history]');
    if (maxJobEl) maxJobEl.value = currentSettings.max_job_history || 100;

    const userAgentEl = document.querySelector('[name=user_agent]');
    if (userAgentEl) userAgentEl.value = currentSettings.user_agent || '';

    const proxyUrlEl = document.querySelector('[name=proxy_url]');
    if (proxyUrlEl) proxyUrlEl.value = currentSettings.proxy_url || '';

    const proxyUserEl = document.querySelector('[name=proxy_username]');
    if (proxyUserEl) proxyUserEl.value = currentSettings.proxy_username || '';

    const proxyPassEl = document.querySelector('[name=proxy_password]');
    if (proxyPassEl) proxyPassEl.value = currentSettings.proxy_password || '';

    // proxy_enabled: default OFF unless explicitly true
    const proxyEnabledEl = document.querySelector('[name=proxy_enabled]');
    if (proxyEnabledEl) proxyEnabledEl.checked = !!currentSettings.proxy_enabled;

    const autoRefreshEl = document.querySelector('[name=auto_refresh_enabled]');
    if (autoRefreshEl) autoRefreshEl.checked = currentSettings.auto_refresh_enabled || false;

    const allowSeriesEl = document.querySelector('[name=allow_non_admin_series_search]');
    if (allowSeriesEl) allowSeriesEl.checked = currentSettings.allow_non_admin_series_search || false;

    // skip_known_series_search: default ON unless explicitly false
    const skipKnownEl = document.querySelector('[name=skip_known_series_search]');
    if (skipKnownEl) skipKnownEl.checked = currentSettings.skip_known_series_search !== false;

    const devModeEl = document.querySelector('[name=developer_mode]');
    if (devModeEl) devModeEl.checked = !!currentSettings.developer_mode;

    const usersCanEditEl = document.querySelector('[name=users_can_edit_frontpage_slug]');
    if (usersCanEditEl) usersCanEditEl.checked = !!currentSettings.users_can_edit_frontpage_slug;

    syncProxyFields();
  }
}

loadSettings();
loadFrontpageSlugOptions();

const form = document.getElementById('settingsForm');
form.addEventListener('submit', async (ev) => {
  ev.preventDefault();
  const data = {
    default_frontpage_slug: (function(){
      const sel = document.getElementById('defaultFrontpageSlugSelect');
      if (sel) return sel.value || null;
      return form.default_frontpage_slug ? (form.default_frontpage_slug.value || null) : (currentSettings && currentSettings.default_frontpage_slug) || null;
    })(),
    rate_rps: form.rate_rps ? (parseFloat(form.rate_rps.value) || currentSettings.rate_rps || 2.0) : (currentSettings && currentSettings.rate_rps) || 2.0,
    max_job_history: form.max_job_history ? (parseInt(form.max_job_history.value,10) || currentSettings.max_job_history || 100) : (currentSettings && currentSettings.max_job_history) || 100,
    auto_refresh_enabled: form.auto_refresh_enabled ? form.auto_refresh_enabled.checked || false : (currentSettings && currentSettings.auto_refresh_enabled) || false,
    manual_refresh_interval_minutes: (form.manual_refresh_interval_minutes ? parseInt(form.manual_refresh_interval_minutes.value,10) : (currentSettings && currentSettings.manual_refresh_interval_minutes)) || 10,
    response_groups: currentSettings && currentSettings.response_groups || null,
    user_agent: form.user_agent ? form.user_agent.value || null : (currentSettings && currentSettings.user_agent) || null,
    allow_non_admin_series_search: form.allow_non_admin_series_search ? form.allow_non_admin_series_search.checked || false : (currentSettings && currentSettings.allow_non_admin_series_search) || false,
    skip_known_series_search: form.skip_known_series_search ? form.skip_known_series_search.checked || false : (currentSettings && currentSettings.skip_known_series_search) !== false,
    debug_logging: form.debug_logging ? form.debug_logging.checked || false : (currentSettings && currentSettings.debug_logging) || false,
    developer_mode: form.developer_mode ? form.developer_mode.checked || false : (currentSettings && currentSettings.developer_mode) || false,
    proxy_enabled: form.proxy_enabled ? form.proxy_enabled.checked || false : (currentSettings && currentSettings.proxy_enabled) || false,
    proxy_url: form.proxy_url ? form.proxy_url.value || null : (currentSettings && currentSettings.proxy_url) || null,
    proxy_username: form.proxy_username ? form.proxy_username.value || null : (currentSettings && currentSettings.proxy_username) || null,
    proxy_password: form.proxy_password ? form.proxy_password.value || null : (currentSettings && currentSettings.proxy_password) || null,
    secret_key: currentSettings && currentSettings.secret_key || null,
    users_can_edit_frontpage_slug: form.users_can_edit_frontpage_slug ? form.users_can_edit_frontpage_slug.checked || false : (currentSettings && currentSettings.users_can_edit_frontpage_slug) || false,
    google_analytics_id: form.google_analytics_id ? form.google_analytics_id.value || null : (currentSettings && currentSettings.google_analytics_id) || null
  };
  const resp = await fetch(apiPath('/api/settings'), {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data)});
  if (resp.ok) {
    document.getElementById('saved').style.display = 'block';
    setTimeout(()=>{document.getElementById('saved').style.display='none'},2000);
    await loadSettings();
    // If developer mode state changed, reload the page so developer-only controls are rendered by the server
    if ((currentSettings && !!currentSettings.developer_mode) !== (form.developer_mode ? !!form.developer_mode.checked : false)) {
      location.reload();
    }
  }
});

document.getElementById('proxyEnabledToggle').addEventListener('change', syncProxyFields);
syncProxyFields();

document.getElementById('testProxyBtn').addEventListener('click', async () => {
  const btn = document.getElementById('testProxyBtn');
  const resultDiv = document.getElementById('proxyTestResult');
  
  btn.disabled = true;
  btn.textContent = 'Testing...';
  resultDiv.style.display = 'none';
  
  try {
    const resp = await fetch(apiPath('/api/settings/test-proxy'), { method: 'POST' });
    const data = await resp.json();
    
    resultDiv.style.display = 'block';
    if (resp.ok && data.success) {
      resultDiv.className = 'alert alert-success mt-2';
      resultDiv.innerHTML = `<strong>✓ Success!</strong> ${data.message || 'Proxy connection working.'}`;
    } else {
      resultDiv.className = 'alert alert-warning mt-2';
      const message = data.error || data.detail || data.message || 'Proxy connection failed.';
      resultDiv.innerHTML = `<strong>⚠ ${message}</strong>`;
    }
  } catch (err) {
    resultDiv.style.display = 'block';
    resultDiv.className = 'alert alert-danger mt-2';
    resultDiv.innerHTML = `<strong>✗ Error!</strong> ${err.message}`;
  } finally {
    btn.disabled = false;
    btn.textContent = 'Test Proxy Connection';
  }
});

document.getElementById('assignScheduleBtn').addEventListener('click', async () => {
  const btn = document.getElementById('assignScheduleBtn');
  const resultDiv = document.getElementById('rescheduleResult');
  
  // Two-step confirm without browser alert
  if (btn.dataset.confirmed !== 'true') {
    btn.dataset.confirmed = 'true';
    btn.textContent = 'Confirm';
    btn.classList.remove('btn-outline-primary');
    btn.classList.add('btn-primary');
    setTimeout(() => {
      if (btn.dataset.confirmed === 'true') {
        btn.dataset.confirmed = '';
        btn.textContent = 'Assign new schedule to all series';
        btn.classList.add('btn-outline-primary');
        btn.classList.remove('btn-primary');
      }
    }, 3000);
    return;
  }
  
  btn.disabled = true;
  btn.textContent = 'Assigning...';
  resultDiv.style.display = 'none';
  
  try {
    const resp = await fetch(apiPath('/api/series/reschedule-all'), { method: 'POST' });
    const data = await resp.json();
    
    resultDiv.style.display = 'block';
    if (resp.ok) {
      resultDiv.className = 'alert alert-success mt-2';
      resultDiv.innerHTML = `<strong>✓ Success!</strong> ${data.message || 'All series rescheduled.'}`;
    } else {
      resultDiv.className = 'alert alert-warning mt-2';
      const message = data.error || data.detail || data.message || 'Reschedule failed.';
      resultDiv.innerHTML = `<strong>⚠ ${message}</strong>`;
    }
  } catch (err) {
    resultDiv.style.display = 'block';
    resultDiv.className = 'alert alert-danger mt-2';
    resultDiv.innerHTML = `<strong>✗ Error!</strong> ${err.message}`;
  } finally {
    btn.disabled = false;
    btn.textContent = 'Assign new schedule to all series';
  }
});

// Refresh All now handler
document.getElementById('refreshAllBtn').addEventListener('click', async () => {
  const btn = document.getElementById('refreshAllBtn');
  const resultDiv = document.getElementById('rescheduleResult');
  
  // Two-step confirm without browser alert
  if (btn.dataset.confirmed !== 'true') {
    btn.dataset.confirmed = 'true';
    btn.textContent = 'Confirm';
    btn.classList.remove('btn-outline-secondary');
    btn.classList.add('btn-secondary');
    setTimeout(() => {
      if (btn.dataset.confirmed === 'true') {
        btn.dataset.confirmed = '';
        btn.textContent = 'Refresh All Series now';
        btn.classList.add('btn-outline-secondary');
        btn.classList.remove('btn-secondary');
      }
    }, 3000);
    return;
  }
  
  btn.disabled = true;
  btn.textContent = 'Refreshing...';
  resultDiv.style.display = 'none';
  
  try {
    const resp = await fetch(apiPath('/api/series/refresh-all'), { method: 'POST' });
    const data = await resp.json();

    resultDiv.style.display = 'block';
    if (resp.ok) {
      resultDiv.className = 'alert alert-success mt-2';
      resultDiv.innerHTML = `<strong>✓ Success!</strong> Refreshed ${data.refresh.count} series; reschedule job ${data.reschedule_job_id} queued.`;
    } else {
      resultDiv.className = 'alert alert-warning mt-2';
      const message = data.error || data.detail || data.message || 'Refresh failed.';
      resultDiv.innerHTML = `<strong>⚠ ${message}</strong>`;
    }
  } catch (err) {
    resultDiv.style.display = 'block';
    resultDiv.className = 'alert alert-danger mt-2';
    resultDiv.innerHTML = `<strong>✗ Error!</strong> ${err.message}`;
  } finally {
    btn.disabled = false;
    btn.textContent = 'Refresh All Series now';
  }
});

document.getElementById('showDbStatsBtn').addEventListener('click', async () => {
  const btn = document.getElementById('showDbStatsBtn');
  const resultDiv = document.getElementById('dbStatsResult');
  
  btn.disabled = true;
  btn.textContent = 'Loading...';
  resultDiv.style.display = 'none';
  
  try {
    const resp = await fetch(apiPath('/api/database/stats'));
    const data = await resp.json();
    
    if (resp.ok) {
      resultDiv.style.display = 'block';
      resultDiv.className = 'mt-3';
      
      let html = '<table class="table table-sm table-bordered"><thead><tr><th>Collection</th><th>Documents</th><th>Data Size</th><th>Index Size</th><th>Total Size</th></tr></thead><tbody>';
      
      let totalData = 0;
      let totalIndex = 0;
      
      data.collections.forEach(col => {
        const dataMB = (col.size / (1024 * 1024)).toFixed(2);
        const indexMB = (col.indexSize / (1024 * 1024)).toFixed(2);
        const totalMB = ((col.size + col.indexSize) / (1024 * 1024)).toFixed(2);
        totalData += col.size;
        totalIndex += col.indexSize;
        
        html += `<tr>
          <td><strong>${col.name}</strong></td>
          <td>${col.count.toLocaleString()}</td>
          <td>${dataMB} MB</td>
          <td>${indexMB} MB</td>
          <td>${totalMB} MB</td>
        </tr>`;
      });
      
      const totalDataMB = (totalData / (1024 * 1024)).toFixed(2);
      const totalIndexMB = (totalIndex / (1024 * 1024)).toFixed(2);
      const grandTotalMB = ((totalData + totalIndex) / (1024 * 1024)).toFixed(2);
      
      html += `<tr class="table-active"><td><strong>TOTAL</strong></td><td></td><td><strong>${totalDataMB} MB</strong></td><td><strong>${totalIndexMB} MB</strong></td><td><strong>${grandTotalMB} MB</strong></td></tr>`;
      html += '</tbody></table>';
      html += '<p class="text-muted small mt-2"><em>Note: Actual disk usage may be higher due to MongoDB internal overhead, journal files, and free space allocation.</em></p>';
      
      resultDiv.innerHTML = html;
    } else {
      resultDiv.style.display = 'block';
      resultDiv.className = 'alert alert-warning mt-3';
      const message = data.error || data.detail || 'Failed to load stats.';
      resultDiv.innerHTML = `<strong>⚠ ${message}</strong>`;
    }
  } catch (err) {
    resultDiv.style.display = 'block';
    resultDiv.className = 'alert alert-danger mt-3';
    resultDiv.innerHTML = `<strong>✗ Error!</strong> ${err.message}`;
  } finally {
    btn.disabled = false;
    btn.textContent = 'Show Database Stats';
  }
});

document.getElementById('purgeAndCompactBtn').addEventListener('click', async () => {
  const btn = document.getElementById('purgeAndCompactBtn');
  const resultDiv = document.getElementById('purgeResult');
  
  // Two-step confirm without browser alert
  if (btn.dataset.confirmed !== 'true') {
    btn.dataset.confirmed = 'true';
    btn.textContent = 'Confirm';
    btn.classList.remove('btn-outline-danger');
    btn.classList.add('btn-danger');
    setTimeout(() => {
      if (btn.dataset.confirmed === 'true') {
        btn.dataset.confirmed = '';
        btn.textContent = 'Purge & Compact Database';
        btn.classList.add('btn-outline-danger');
        btn.classList.remove('btn-danger');
      }
    }, 3000);
    return;
  }
  
  btn.disabled = true;
  btn.textContent = 'Purging & Compacting...';
  resultDiv.style.display = 'block';
  resultDiv.className = 'alert alert-info mt-2';
  resultDiv.innerHTML = '<strong>⏳ Working...</strong> This may take several minutes. Please wait...';
  
  try {
    const resp = await fetch(apiPath('/api/series/purge-and-compact'), { method: 'POST' });
    const data = await resp.json();
    
    resultDiv.style.display = 'block';
    if (resp.ok) {
      resultDiv.className = 'alert alert-success mt-2';
      const beforeMB = (data.size_before / (1024 * 1024)).toFixed(2);
      const afterMB = (data.size_after / (1024 * 1024)).toFixed(2);
      const savedMB = (beforeMB - afterMB).toFixed(2);
      resultDiv.innerHTML = `<strong>✓ Success!</strong> Purged ${data.purged_count || 0} series and compacted database.<br>Series collection: ${beforeMB} MB → ${afterMB} MB (saved ${savedMB} MB)`;
    } else {
      resultDiv.className = 'alert alert-warning mt-2';
      const message = data.error || data.detail || data.message || 'Operation failed.';
      resultDiv.innerHTML = `<strong>⚠ ${message}</strong>`;
    }
  } catch (err) {
    resultDiv.style.display = 'block';
    resultDiv.className = 'alert alert-danger mt-2';
    resultDiv.innerHTML = `<strong>✗ Error!</strong> ${err.message}`;
  } finally {
    btn.disabled = false;
    btn.textContent = 'Purge & Compact Database';
  }
});

document.getElementById('dumpRestoreBtn').addEventListener('click', async () => {
  const btn = document.getElementById('dumpRestoreBtn');
  const resultDiv = document.getElementById('dumpRestoreResult');
  
  // Two-step confirm without browser alert
  if (btn.dataset.confirmed !== 'true') {
    btn.dataset.confirmed = 'true';
    btn.textContent = 'Confirm';
    btn.classList.remove('btn-outline-warning');
    btn.classList.add('btn-warning');
    setTimeout(() => {
      if (btn.dataset.confirmed === 'true') {
        btn.dataset.confirmed = '';
        btn.textContent = 'Dump & Restore (Reclaim Space)';
        btn.classList.add('btn-outline-warning');
        btn.classList.remove('btn-warning');
      }
    }, 3000);
    return;
  }
  
  btn.disabled = true;
  document.getElementById('showDbStatsBtn').disabled = true;
  document.getElementById('purgeAndCompactBtn').disabled = true;
  btn.textContent = 'Dumping & Restoring...';
  resultDiv.style.display = 'block';
  resultDiv.className = 'alert alert-info mt-2';
  resultDiv.innerHTML = '<strong>⏳ Working...</strong> Dumping database, rebuilding, and restoring. This will take several minutes. Please wait...';
  
  try {
    const resp = await fetch(apiPath('/api/database/dump-restore'), { method: 'POST' });
    const data = await resp.json();
    
    resultDiv.style.display = 'block';
    if (resp.ok) {
      resultDiv.className = 'alert alert-success mt-2';
      const beforeMB = (data.size_before / (1024 * 1024)).toFixed(2);
      const afterMB = (data.size_after / (1024 * 1024)).toFixed(2);
      const savedMB = (beforeMB - afterMB).toFixed(2);
      const savedPercent = ((savedMB / beforeMB) * 100).toFixed(1);
      resultDiv.innerHTML = `<strong>✓ Success!</strong> Database rebuilt successfully.<br>
        Size: ${beforeMB} MB → ${afterMB} MB (saved ${savedMB} MB, ${savedPercent}% reduction)<br>
        <em class="small">Disk space will be reclaimed shortly. Run "Show Database Stats" to verify.</em>`;
    } else {
      resultDiv.className = 'alert alert-danger mt-2';
      const message = data.error || data.detail || data.message || 'Operation failed.';
      resultDiv.innerHTML = `<strong>✗ Error!</strong> ${message}`;
    }
  } catch (err) {
    resultDiv.style.display = 'block';
    resultDiv.className = 'alert alert-danger mt-2';
    resultDiv.innerHTML = `<strong>✗ Error!</strong> ${err.message}`;
  } finally {
    btn.disabled = false;
    document.getElementById('showDbStatsBtn').disabled = false;
    document.getElementById('purgeAndCompactBtn').disabled = false;
    btn.textContent = 'Dump & Restore (Reclaim Space)';
  }
});
</script>
{% endblock %}
